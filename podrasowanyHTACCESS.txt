## trochê podrasowany .htaccess pod wordpresa
## 18.12.2017
## wersja zgodna z apache 2.2 (i hostingami akceptuj¹cymi te znaczniki)
## u¿ywasz na w³asn¹ odpowiedzialnoœæ :) #SOA1
## niektóre wtyczki/motywy dopisuj¹ swoje regó³ki do .htaccess wiêc zacznij od skopiowania swojego obecnego pliku .htaccess ¿eby by³o co przywróciæ w czarnej godzinie
## w tym pliku skasuj pojedyncze # na pocz¹tkach linii
## jak wiesz co robisz mo¿esz skasowaæ równie¿ i podwójne # w niektórych liniach
## dopasuj konfiguracjê œcie¿ek do plików zamieszczonych na Twoim serwerze
## utwórz plik z has³ami .htpasswd (https://goo.gl/sZJBbz) najlepiej w katalogu niedostêpnym z poziomu www
## wgraj ten plik (który w³aœnie czytasz) w katalog g³ówny wordpressa pod nazw¹ .htaccess
## oczywiœcie je¿eli zawarte tu parametry/warunki s¹ niewystarczaj¹ce nale¿y je zmieniæ
## nieu¿ywane przez siebie sekcje skasuj, wiêkszoœæ alternatywnych jest oznaczona poprzez (mo¿na skasowaæ)
## znajdŸ 666.666.666.666 i podmieñ na adres IP z którego siê ³¹czysz
## utwórz pliki .htaccess opisane w sekcji "inne katalogi" (nie zapomnij skasowaæ w nich #)
## rozwa¿ zmianê uprawnieñ do pliku .htaccess opisane w sekcja "prawa dostêpu"
## skasuj wszystko poni¿ej linii  # END WordPress
## wpadnij na wordup warszawa napiæ siê rumu z @bibliotekarz
## aktualizacje pliku znajdziesz pod adresem http://am.vj.pl/2017/01/22/htaccess-do-wordpressa/

## wy³aczamy podpis serwera
# ServerSignature Off

## dodanie/zmiana sposobu obs³ugi plików mime types mo¿esz dodaæ w³asne typy plików (mo¿na skasowaæ)
# AddType application/x-shockwave-flash .swf
# AddType video/x-flv .flv
# AddType image/x-icon .ico

## dodanie nag³ówka na czeœæ Terrego Pracheta (jesli lubisz jego twórczoœæ) (mo¿na skasowaæ)
# <IfModule headers_module>
#  header set X-Clacks-Overhead "GNU Terry Pratchett"
# </IfModule>

## dodanie nag³ówków blokuj¹cych ataki XSS
# <IfModule mod_headers.c>
#  Header set X-Content-Type-Options nosniff
# </IfModule>
# <IfModule mod_headers.c>
#  Header set X-XSS-Protection "1; mode=block"
# </IfModule>

## ograniczanie wielkoœci pliku przesy³anego na serwer z poziomu apacza w bajtach, 0-2147483647(2GB)
## poni¿ej ograniczenie do 10BM
# LimitRequestBody 10240000

## dodatkowe parametry dla php zwiêkszaj¹ce
## rozmiar uploadu dla pojedyñczego pliku
# php_value upload_max_filesize 25M
## rozmiar upload dla wielu plików jednoczeœnie wysy³anych (czyli powinno byæ wiêksze równe upload_max_filesize)
# php_value post_max_size 50M
## wyd³u¿enie czasu wykonywania skryptu
# php_value max_execution_time 300
## wyd³u¿enie czasu uploadu
# php_value max_input_time 300

###########################
## pakowanie i keszowanie #
###########################

## tworzenie znaczników ETag (mo¿na skasowaæ)
## mo¿na wdrozyæ ale lepiej siê skupiæ na Expires (poni¿ej)
# <Files "\.(gif|jpe?g|png|pdf)$">
#  FileETag MTime Size
# </Files>

# <IfModule mod_expires.c>
# ExpiresActive On
# ExpiresByType image/jpg "access plus 1 year"
# ExpiresByType image/jpeg "access plus 1 year"
# ExpiresByType image/gif "access plus 1 year"
# ExpiresByType image/png "access plus 1 year"
# ExpiresByType text/css "access plus 1 month"
# ExpiresByType application/pdf "access plus 1 month"
# ExpiresByType text/x-javascript "access plus 1 month"
# ExpiresByType application/x-shockwave-flash "access plus 1 month"
# ExpiresByType image/x-icon "access plus 1 year"
# ExpiresDefault "access plus 2 days"
# </IfModule>

## wersja dla serwisów na home.pl bo u nich nie dzia³aj¹ dyrektywy przytoczone powy¿sze (mo¿na skasowaæ)
# :Location /*.(gif|jpg|png|jpeg|ico)
# Expires A3110400
# :Location
# :Location /*.(txt|css|js|php|pl)
# Expires A2592000
# :Location
# :Location /*.(html|htm)
# Expires A86400
# :Location

## na home.pl nie dzia³a FilesMach (mo¿na skasowaæ tylko w przypadku home.pl)
## 2592000 = 30 dni, 864000 = 10 dni
# <ifModule mod_headers.c>
#  <FilesMatch "\.(js|css|xml|gz|html)$">
#    Header append Vary: Accept-Encoding
#  </FilesMatch>
# Header unset ETag
# <filesMatch "\\.(ico|pdf|flv|jpg|jpeg|png|gif|swf)$">
#  Header set Cache-Control "max-age=2592000, public"
# </filesMatch>
# <filesMatch "\\.(css)$">
# Header set Cache-Control "max-age=864000, private"
# </filesMatch>
# <filesMatch "\\.(js)$">
#  Header set Cache-Control "max-age=864000, private"
# </filesMatch>
# <filesMatch "\\.(xml|txt)$">
#  Header set Cache-Control "max-age=2592000, public, must-revalidate"
# </filesMatch>
# <filesMatch "\\.(html|htm|php)$">
#  Header set Cache-Control "max-age=864000, private, must-revalidate"
# </filesMatch>
# </ifModule>

## w³¹czanie kompresji

# <IfModule mod_deflate.c>
# AddOutputFilterByType DEFLATE text/text
# AddOutputFilterByType DEFLATE text/html
# AddOutputFilterByType DEFLATE text/css
# AddOutputFilterByType DEFLATE text/javascript
# AddOutputFilterByType DEFLATE text/xml
# AddOutputFilterByType DEFLATE text/plain
# AddOutputFilterByType DEFLATE image/x-icon
# AddOutputFilterByType DEFLATE image/svg+xml
# AddOutputFilterByType DEFLATE application/rss+xml
# AddOutputFilterByType DEFLATE application/javascript
# AddOutputFilterByType DEFLATE application/x-javascript
# AddOutputFilterByType DEFLATE application/xml
# AddOutputFilterByType DEFLATE application/xhtml+xml

## Zachowanie zgodnoœci ze starymi przegl¹darkami
# BrowserMatch ^Mozilla/4 gzip-only-text/html
# BrowserMatch ^Mozilla/4\.0[678] no-gzip
# BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
# SetOutputFilter DEFLATE
# SetEnvIfNoCase RequestURI .(?:gif|jpe?g|png)$ no-gzip dont-vary
# SetEnvIfNoCase RequestURI .(?:exe|t?gz|zip|bz2|sit|rar)$ no-gzip dont-vary
# SetEnvIfNoCase Request_URI .pdf$ no-gzip dont-vary
# </IfModule>

## tylko jeœli nie serwer nie obs³uguje mod_deflate inaczej (mo¿na skasowaæ)
# <ifModule mod_gzip.c>
# mod_gzip_on Yes
# mod_gzip_dechunk Yes
# mod_gzip_item_include file \.(html?|txt|css|js|php|pl)$
# mod_gzip_item_include mime ^application/x-javascript.*
# mod_gzip_item_include mime ^text/.*
# mod_gzip_item_exclude rspheader ^Content-Encoding:.*gzip.*
# mod_gzip_item_exclude mime ^image/.*
# mod_gzip_item_include handler ^cgi-script$
# </ifModule>

################
## autoryzacja #
################

### jeœli potrzebujesz blokowania wszystkiego dostêp po podaniu has³a (mo¿na skasowaæ)
## AuthName "No pasaran test_jakis_opis"
## AuthType Basic
## AuthUserFile /sciezka/serwera/najlepiej/przed/katalogiem/widocznym/z/poziomu/www/.htpasswd
## Require valid-user

## konieczne ¿eby wyci¹æ boty
# <Files wp-login.php>
#    AuthType Basic
#    AuthName "Czego tu szukasz"
#    AuthUserFile /sciezka/serwera/najlepiej/przed/katalogiem/widocznym/z/poziomu/www/.htpasswd
#    require valid-user
# </Files>

### wygodniejsza blokada z dostêpem bez has³a (na podstawie adresu IP) mo¿esz podaæ wiele adresów lub klasê sieci (mo¿na skasowaæ)
## <Files wp-login.php>
##    AuthType Basic
##    require valid-user
##    Order allow,deny
##    Allow from 666.666.666.666
##    Allow from 666.666.666.
##    Satisfy Any
## </Files>

### ograniczenie dostêpu tylko do lokalnej sieci i domeny tere.vj.pl (mo¿na skasowaæ)
## <Limit GET POST PUT>
## order deny,allow
## deny from all
## allow from 192.168.0.0/24
## allow from .tere\.vj\.pl.*
## mo¿emy jednak zablokowaæ niechcianych
## deny from 192.168.0.19
## </Limit>

###################
## przekierowania #
###################

## 401 – Unauthorized przekierowanie na jakiœ inny adres
## ErrorDocument 401 http://vj.pl/401.html

## 403 – Forbidden brak dostêpu przekierowanie na lokalny plik
## ErrorDocument 403 /dostep_zablokowany.html

## 404 – Not Found czyli nie znaleziono wyœwietli komunikat zawarty w cudzys³owach
## przekierowanie nie zadzia³a przy w³¹czonych przyjaznych adresach w wordpressie
## ErrorDocument 404 "<h1>404</h1> <h2>oznacza ¿e nie znaleziono tego pliku</h2>"

## 410 – Gone czyli niema i nie bêdzie wyœwietli komunikat zawarty w cudzys³owach
## ErrorDocument 410 "plik zakoñczy³ ¿ywot i nie wróci z tamtego œwiata<br>410"

## 500 - error czyli b³¹d serwera przekierowanie na lokalny plik
## ErrorDocument 500 /padla.html

## 301 przekierowanie permanentne na zawsze pod SEO dopasuj jeœli potrzebijesz lub skasuj sekcjê
## Redirect 301 /duda.html http://prezydent.pl
## Redirect 301 /stary-folder/duda.html /nowy-folder/duda-nowy-ta-sama-domena.html
## Redirect 301 / http://vj.pl

## 302 przekierowanie tymczasowe dopasuj jeœli potrzebijesz lub skasuj sekcjê
## Redirect 302 /wp-content/duda.html /wp-content/uploads/wymiana-wkladu-w-dlugopisie.html
## Redirect 302 /mod_rewrite.html https://httpd.apache.org/docs/2.4/rewrite/intro.html

## w³¹czamy modu³ mod_rewrite
# RewriteEngine on

## ustawiamy g³ówn¹ œcie¿kê do katalogu wordpressa
# RewriteBase /

############# Dyrektywy ##########################
## Directory do katalogów na dysku serwera       #
## Files do konkretnego pliku na dysku serwera   #
## Location odwo³uje siê do adresu internetowego #
##################################################

############
## blokady #
############

## blokujemy przegl¹danie katalogów i wykonywanie skryptów CGI
# Options All -ExecCGI -Indexes

## alternatywnie do blokowanie wyœwietlania u¿ywamy
## dla wszystkiego
# IndexIgnore *
## dla poszczególnych typów plików (resztê bêdzie widaæ) dodaj rozsze¿enie które chesz ukryæ
# IndexIgnore *.backup *.old
# IndexIgnore *.txt

## Pliki zabronione pod wordpressa
# <FilesMatch "wp-config*\.php|\.htaccess|\.htpasswd">
#    Order allow,deny
#    Deny from all
# </FilesMatch>

# <Files xmlrpc.php>
#    Order deny,allow
#    Deny from all
# </Files>

# <Files install.php>
#    Order deny,allow
#    Deny from all
# </Files>

# <Files readme.txt>
#    Order allow,deny
#    Deny from all
# </Files>

## wy³¹czanie uruchamiania skryptów w katalogu uploadu
# <Directory "/sciezka/serwera/do/katalogu/wp-content/uploads">
#     AddHandler cgi-script .php .pl .py .jsp .asp .htm .shtml .sh .cgi
#     Options -ExecCGI
# </Directory>

## blokada listowanie plików wedle potrzeby (mo¿na skasowaæ sekcjê)

# <Files ~ ".(old|backup|log)$">
# Order deny,allow
# Deny from all
# </Files>

## blokada listowania autorów

# RewriteCond %{QUERY_STRING} author=\d*
# RewriteRule .*$ /? [L,R=301]

## alternatywnie blokada (w roocie zamiast w katalogu) dostêpu do zawartoœci katalogów wp-includes

# <IfModule mod_rewrite.c>
#    RewriteRule ^wp-admin/includes/ - [F,L]
#    RewriteRule !^wp-includes/ - [S=3]
#    RewriteRule ^wp-includes/[^/]+\.php$ - [F,L]
#    RewriteRule ^wp-includes/js/tinymce/langs/.+\.php - [F,L]
#    RewriteRule ^wp-includes/theme-compat/ - [F,L]
# </IfModule>

## blokada dostêpu do nieu¿ywanych metod zapytañ

# RewriteCond %{REQUEST_METHOD} ^(TRACE|TRACK|OPTIONS|HEAD) [NC]
# RewriteRule .* - [F]

#################
## odblokowanie #
#################

## dziêki "Satisfy any"  umo¿liwiamy dostêp do plików w podkatalogu

# <FilesMatch "admin-ajax\.php|admin-post\.php">
#    Order allow,deny
#    Allow from all
#    Satisfy any
# </FilesMatch>

####################################################
## wymuszanie pobierania na podstawie rozszerzenia #
####################################################

## narzuca pobieranie plików zamiast wyœwietlania
# <FilesMatch "\.(txt|pdf|PDF|docx|odf|xlsx)$" >
#    ForceType application/octet-stream
#    Header add Content-Disposition "attachment"
# </FilesMatch>

## narzuca pobieranie plików z ca³ego katalogu "uploads" zamiast wyœwietlania
# <IfModule mod_headers.c>
#  <Location ~ ".*/uploads/.*">
#    Order allow,deny
#    Allow from all
#  </Location>
# </IfModule>

### przekierowanie z g³ównej na subdomenê www (mo¿na skasowaæ)
## RewriteCond %{HTTP_HOST} !^$
## RewriteCond %{HTTP_HOST} !^www\.test\.vj\.pl$ [NC]
## RewriteRule ^/(.*)$ http://www.test.vj.pl/$1 [L,R=301]

### wymuszanie ssl (mo¿na skasowaæ)
## RewriteCond     %{SERVER_PORT} ^80$
## RewriteRule     ^(.*)$ https://%{SERVER_NAME}%{REQUEST_URI} [L,R]

####################
## zabawy z czasem #
####################

### w zale¿noœci od godziny podmienia serwowany plik (mo¿na skasowaæ)
## RewriteCond   "%{TIME_HOUR}%{TIME_MIN}" >0700
## RewriteCond   "%{TIME_HOUR}%{TIME_MIN}" <1900
## RewriteRule   "^style\.css$"             "dzien.css" [L]
## RewriteRule   "^style\.css$"             "noc.css"

###############################################
## czasowa konserwacja, admin ma dostêp po IP #
###############################################

## musisz mieæ plik przerwa-techniczna.html (mo¿na skasowaæ)
# RewriteEngine on
# RewriteCond %{REQUEST_URI} !/przerwa-techniczna.html$
# RewriteCond %{REMOTE_ADDR} !^666\.666\.666\.666
# RewriteRule $ /przerwa-techniczna.html [R=302,L]

########################
## dodatkowe wycinanki #
########################

## blokada skryptów i SQLi poprzez URL-a

## skrypty wywo³uj¹ce base64_encode w adresie
# RewriteCond %{QUERY_STRING} base64_encode[^(]*\([^)]*\) [OR]

## wywo³ania <script> w adresie
# RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]

## wywo³ania zmiennych PHP GLOBALS w adresie
# RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]

## modyfikowanie zmiennej _REQUEST poprzez adres
# RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]

## wyjscie katalog wy¿ej
# RewriteCond %{QUERY_STRING} \.\.\/ [NC,OR]

## rozszerzenia spoza www
# RewriteCond %{QUERY_STRING} ^.*\.(bash|git|hg|log|svn|swp|cvs) [NC,OR]

## œcie¿ka do plików serwera
# RewriteCond %{QUERY_STRING} etc/passwd [NC,OR]
# RewriteCond %{QUERY_STRING} boot\.ini [NC,OR]

## ucieczka z protoko³u sieciowego, przejœcie na localhosta
# RewriteCond %{QUERY_STRING} ftp\:  [NC,OR]
# RewriteCond %{QUERY_STRING} http\:  [NC,OR]
# RewriteCond %{QUERY_STRING} https\:  [NC,OR]
# RewriteCond %{QUERY_STRING} ^.*(127\.0).* [NC,OR]

## s³owa "zastrze¿one" w URLu
# RewriteCond %{QUERY_STRING} ^.*(%24&x).* [NC,OR]
# RewriteCond %{QUERY_STRING} (menu|mod|path|tag)\=\.?/? [NC,OR]
# RewriteCond %{QUERY_STRING} ^.*(globals|encode|localhost|loopback).* [NC,OR]
# RewriteCond %{QUERY_STRING} ^.*(request|concat|insert|union|declare).* [NC,OR]
# RewriteCond %{QUERY_STRING} !^loggedout=true [NC,OR]
# RewriteCond %{QUERY_STRING} !^action=jetpack-sso [NC,OR]
# RewriteCond %{QUERY_STRING} !^action=rp

## powy¿sze RewriteCond powoduj¹ wywo³anie przekierowania na 403 i pokazanie strony g³ównej
# RewriteRule .* index.php [F]

## wycinka hotlinkowania obrazków wstaw w³asn¹ domenê (mo¿na skasowaæ)
## uwaga blokuje równie¿ googla
# RewriteCond %{HTTP_REFERER} !^$
# RewriteCond %{HTTP_REFERER} !^http://(www\.)?vj.pl/.*$ [NC]
# RewriteRule \.(gif|jpg|swf|flv|png)$ http://vj.pl/domyslny-obrazek-blokady.jpg [R=302,L]

## wycinka komentarzy bez referera i z pustym opisem przegl¹darki
# RewriteCond %{REQUEST_METHOD} POST
# RewriteCond %{REQUEST_URI} .wp-comments-post\.php*
# RewriteCond %{HTTP_REFERER} !.*test.vj.pl.* [OR]
# RewriteCond %{HTTP_USER_AGENT} ^$
# RewriteRule (.*) ^http://%{REMOTE_ADDR}/$ [R=301,L]

## blokada u¿ytkowników przychodz¹cych z niechcianych stron (mo¿na skasowaæ)
## przez analogiê dopisz niechciane Ÿród³owe domeny/wyrazenia do zmiennej spam_ref
# SetEnvIfNoCase Referer "^http://(www.)?jakiœ-refferer.com" spam_ref = 1
# SetEnvIfNoCase Referer "^http://(www.)?jakiœ-site.com" spam_ref = 1
# SetEnvIfNoCase Referer "^wyra¿enie-zawarte-w-address-url" spam_ref = 1
## wykonanie blokowania ca³ego zestawu ze spam_ref
# <FilesMatch "(.*)">
#   Order Allow, Deny
#   Allow from all
#   Deny from env = spam_ref
# </ FilesMatch>

## rozwa¿ wklejenie antybotowej paczki http://pastebin.com/BPRv4TDd

# BEGIN WordPress
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
RewriteRule ^index\.php$ - [L]
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.php [L]
</IfModule>

# END WordPress

##################
## inne katalogi #
##################

## W katalogu wp-admin dodaj plik .htaccess o treœci

## AuthType Basic
## AuthGroupFile /dev/null
## AuthName "Czego tu szukasz"
## AuthUserFile /sciezka-do-htpasswd/.htpasswd
## require valid-user

### <FilesMatch "admin-ajax\.php|admin-post\.php">
###    Order allow,deny
###    Allow from all
###    Satisfy any
### </FilesMatch>

### W katalogu wp-includes dodaj plik .htaccess o treœci

### <FilesMatch "\.(?i:php)$">
#### ?i: tryb http://www.gajdaw.pl/php/wyrazenia-regularne-pcre-php-tutorial/print.html#R22
###         Order allow,deny
###         Deny from all
### </FilesMatch>

### <Files wp-tinymce.php>
###        Allow from all
### </Files>

### <Files ms-files.php>
###        Allow from all
### </Files>

### W katalogu uploads dodaj plik .htaccess o treœci

### <FilesMatch "\.(?i:php)$">
###        Order allow,deny
###        Deny from all
### </FilesMatch>

##################
## prawa dostêpu #
##################

## Standardowe uprawnienia .htaccess to 644 (rw- r-- r--)
## zalecane Tryb tylko do odczytu .htaccess permissions to 444 (r-- r-- r--) (blokuje czêœæ wtyczek i zmiany œcie¿ek z poziomu administracji wordpressa)